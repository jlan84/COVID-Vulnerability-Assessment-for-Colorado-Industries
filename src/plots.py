import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from df_functions import *

plt.style.use('bmh')

df = pd.read_csv('../data/updated_table.csv')

df['Total Staff Infected'] = (df['Number of staff who are positive for COVID-19 (lab confirmed)'] +
                              df['Number of staff with probable COVID-19 (NOT lab confirmed)'])

county_infection_group = df.groupby('Colorado county (exposure location)').sum().copy().reset_index()
county_infection_group.sort_values('Total Staff Infected', ascending=False, inplace=True)

county_hispanic_group = df.groupby('Colorado county (exposure location)').mean().copy().reset_index()
county_hispanic_group.sort_values('Total Staff Infected', ascending=False, inplace=True)


industry_group = df.groupby(['Industry']).count().copy().reset_index()
industry_group.sort_values('Median Salary', ascending=False, inplace=True)



# make_bar_plot(ax, county_infection_group, 'Total Staff Infected', 
#              'Colorado county (exposure location)', 'Staff COVID19 Contractions by County',
#               color='firebrick', label='Infections')

# make_bar_plot(ax, county_hispanic_group, 'Hispanic Population Percentage',
#               'Colorado county (exposure location)', 'Hispanic Population %  by County',
#               color='blueviolet', label='Hispanic Population %')

# make_bar_plot(ax, industry_group, 'Median Salary', 'Industry', 'Breakout Report by Industry', 
#               color='olive')



# ax.legend(['Infections','Hispanic Population %'])

# plt.tight_layout()

# plt.show()


df2 = pd.read_csv('../data/wealth-and-health-by-county.csv', header=1, nrows=64)
df2.dropna(how='all', axis=1, inplace=True)
df2['Ratio_Hispanic_Pop'] = df2['Perc_Hispanic_Pop'].str.rstrip('%').astype('float') / 100.0

hispanic_pop_by_county_df = df2[['CTYNAME', 'Ratio_Hispanic_Pop']].copy()
hispanic_pop_by_county_df['Perc_Hispanic_Pop'] = hispanic_pop_by_county_df['Ratio_Hispanic_Pop']*100
hispanic_pop_by_county_df['CTYNAME'] = hispanic_pop_by_county_df['CTYNAME'].str.rstrip()

county_infection_group = df.groupby('Colorado county (exposure location)').sum().copy().reset_index()
county_infection_group.sort_values('Total Staff Infected', ascending=False, inplace=True)

county_infection_group_filtered = county_infection_group[['Colorado county (exposure location)',
                                                          'Total Staff Infected']]

county_infection_group_filtered.rename(columns={'Colorado county (exposure location)': 'CTYNAME'}, inplace=True)

merge_hispPop_Infection = county_infection_group_filtered.merge(hispanic_pop_by_county_df, how='left', on='CTYNAME')
# merge_hispPop_Infection.to_csv('../data/throwaway.csv')



# make_scatter_plot(ax, merge_hispPop_Infection['Perc_Hispanic_Pop'], 
#                   merge_hispPop_Infection['Total Staff Infected'], 'Infected vs Hispanic Population %',
#                   'blueviolet')

# ax.set_xlabel('Hispanic Population %', fontsize=14)
# ax.set_ylabel('Staff Infected', fontsize=14)

# fig, ax = plt.subplots(figsize=(10,8))

# make_bar_plot(ax, merge_hispPop_Infection, 'Total Staff Infected', 
#              'CTYNAME', 'Staff COVID19 Contractions by County',
#               color='firebrick', label='Infections')

# make_bar_plot(ax, merge_hispPop_Infection, 'Perc_Hispanic_Pop', 
#              'CTYNAME', 'Infections and Hispanic Population % by County',
#               color='blueviolet', label='Hispanic Population %')

# ax.legend(['Infections','Hispanic Population %'])
# plt.tight_layout()
# plt.show()

make_grouped_bar_plot(merge_hispPop_Infection, 'CTYNAME', 'Total Staff Infected')

plt.show()